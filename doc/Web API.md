# Web API

This document outlines the endpoints that are available when running gactar as a web server (i.e. by passing `-w` on the command line). The parameters and return interfaces are presented using [TypeScript](https://www.typescriptlang.org). More detail, along with the actual calls to the server, may be found in `web/gactar-web/src/api.ts`.

All endpoints are prefixed by `/api/`.

**Important Note:** The web API is intended for _local use only_. It should not be used to expose gactar to the internet. It is not designed for security or to prevent abuse.

# General

## /version

Get the version of gactar being run.

### Parameters

&nbsp;&nbsp;&nbsp;(none)

### Returns

```ts
type Version = string

interface VersionResponse {
  // The current version tag when gactar was built.
  version: string
}
```

### Example

```
http://localhost:8181/api/version
```

Result:

```json
{
  "version": "v0.2.0"
}
```

## /frameworks

Get a list of frameworks supported by the current gactar installation.

### Parameters

&nbsp;&nbsp;&nbsp;(none)

### Returns

`FrameworkInfoResponse` which is an array of `FrameworkInfo` - one entry per framework.

```ts
interface FrameworkInfo {
  // Name (id) of the framework.
  name: string

  // Language the framework uses.
  language: string

  // File extension of the intermediate file.
  fileExtension: string

  // Name of the executable that was run.
  executableName: string

  // (Python only) List of packages this framework requires.
  pythonRequiredPackages?: string[]
}

type FrameworkInfoList = FrameworkInfo[]

interface FrameworkInfoResponse {
  frameworks: FrameworkInfoList
}
```

### Example

```
http://localhost:8181/api/frameworks
```

Result:

```json
{
  "frameworks": [
    {
      "name": "ccm",
      "language": "python",
      "fileExtension": "py",
      "executableName": "python3",
      "pythonRequiredPackages": ["python_actr"]
    },
    {
      "name": "vanilla",
      "language": "commonlisp",
      "fileExtension": "lisp",
      "executableName": "sbcl"
    }
  ]
}
```

## /run

### Parameters

```ts
interface RunParams {
  // The text of the amod to run.
  amod: string

  // The starting goal.
  goal: string

  // An optional list of frameworks ("all" if not set).
  frameworks?: string[]
}
```

### Returns

`Results` which is a map of `Result` - one entry for each framework that was run.

```ts
interface Result {
  // Name of the model (from the amod text).
  modelName: string

  // Intermediate code file (full path).
  filePath: string

  // Code which was run.
  code?: string

  // Output of run (stdout + stderr).
  output: string
}

type ResultMap = { [key: string]: Result }

interface Results {
  results: ResultMap
}
```

### Example

```
 http://localhost:8181/api/run
```

Request payload:

```json
{
  "amod": "==model==\nname: count\n ...",
  "goal": "countFrom: 2 5 starting"
}
```

Result:

```json
{
  "results": {
    "ccm": {
      "modelName": "count",
      "code": "# Generated by gactar v0.4.0 ...",
      "output": "   0.000 production_match_delay 0 ...\n"
    },
    "pyactr": {
      "modelName": "count",
      "code": "# Generated by gactar v0.4.0 ...",
      "output": "(0, 'PROCEDURAL', 'CONFLICT RESOLUTION') ..."
    },
    "vanilla": {
      "modelName": "count",
      "code": ";;; Generated by gactar v0.4.0 ...",
      "output": "0.000   GOAL                   SET-BUFFER-CHUNK GOAL GOAL NIL ..."
    }
  }
}
```

# Examples

## /examples/list

Get a list of the available examples built-in to the server.

### Parameters

&nbsp;&nbsp;&nbsp;(none)

### Returns

The amod file names which may be used with the `/examples/[example_name]` endpoint.

```ts
interface ExampleList {
  // List of example names which are built into the webserver.
  exampleList: string[]
}
```

### Example

```
 http://localhost:8181/api/examples/list
```

Result:

```json
{
  "exampleList": [
    "addition.amod",
    "addition2.amod",
    "count.amod",
    "semantic.amod",
    "topdown_parser.amod"
  ]
}
```

## /examples/[example_name]

Get the specified built-in example from the server.

### Parameters

The name of the example (as part of the URL).

### Returns

The amod code for the requested example. (Note that it is not JSON like the other endpoints - it is straight text.)

### Example

```
 http://localhost:8181/api/examples/count.amod
```

Result:

```
==model==

// The name of the model (used when generating code and for error messages)
name: count

...
```

# Sessions

## /session/begin

### Parameters

&nbsp;&nbsp;&nbsp;(none)

### Returns

**sessionID** integer

&nbsp;&nbsp;&nbsp;The id of the new session.

### Example

```
 http://localhost:8181/api/session/begin
```

Result:

```json
{
  "sessionID": 1
}
```

## /session/end

### Parameters

**sessionID** integer

&nbsp;&nbsp;&nbsp;The id of the session to end.

### Returns

&nbsp;&nbsp;&nbsp;(none)

### Example

```
 http://localhost:8181/api/session/end
```

Request payload:

```json
{
  "sessionID": 1
}
```

## /session/runModel

### Parameters

```ts
interface SessionRunParams {
  // The id of the session.
  sessionID: number

  // The ID of the model to run.
  modelID: number

  // The initial contents of the buffers.
  buffers: string

  // An optional list of frameworks ("all" if not set).
  frameworks?: string[]

  // Whether to include the generated code as part of the response.
  includeCode: boolean
}
```

### Returns

`SessionRunResults` which is a map of `SessionRunResult` - one entry for each framework that was run.

```ts
interface SessionRunResult extends Result {
  // The id of the session.
  sessionID: number

  // The ID of the model which was run.
  modelID: number
}

export type SessionResultMap = { [key: string]: SessionRunResult }

export interface SessionRunResults {
  results: SessionResultMap
}
```

`SessionRunResult` is just an extension of the `Result` interface to add session & model IDs.

### Example

```
 http://localhost:8181/api/session/runModel
```

Request payload:

```json
{
  "sessionID": 1,
  "modelID": 1,
  "buffers": {
    "goal": "countFrom: 2 5 starting"
  }
}
```

Result:

```json
{
  "results": {
    "ccm": {
      "modelName": "count",
      "output": "   0.000 production_match_delay 0 ...\n",
      "sessionID": 7,
      "modelID": 2
    },
    "pyactr": {
      "modelName": "count",
      "output": "(0, 'PROCEDURAL', 'CONFLICT RESOLUTION') ...",
      "sessionID": 7,
      "modelID": 2
    },
    "vanilla": {
      "modelName": "count",
      "output": "0.000   GOAL                   SET-BUFFER-CHUNK GOAL GOAL NIL ...",
      "sessionID": 7,
      "modelID": 2
    }
  }
}
```

# Models

## /model/load

Given a model (amod code), compile and store it on the server. It returns an id to use to reference the model.

### Parameters

```ts
interface ModelParams {
  // The amod code to load.
  amod: string

  // The id of the session to load this model in.
  sessionID: number
}
```

### Returns

```ts
interface ModelLoadResult {
  // The ID of this model to use in other calls to the API.
  modelID: number

  // The name of the model (comes from the amod code).
  modelName: string

  // The id of the session.
  sessionID: number
}
```

### Example

```
 http://localhost:8181/api/model/load
```

Request payload:

```json
{
  "amod": "==model==\nname: count\n ...",
  "sessionID": 1
}
```

Result:

```json
{
  "modelID": 1,
  "modelName": "count",
  "sessionID": 1
}
```
